@page "/Game"
@using Microsoft.Extensions.Logging
@inject IJSRuntime _jsRuntime
@inject ILogger<Game> _logger

<PageTitle>EMQ</PageTitle>

<h3>Game</h3>

<button class="btn btn-primary" @onclick="SwapSongs">Swap Songs</button>

<div id="gameGrid" style="display: flex;">
    <div class="videoPlayer" style="flex: 50%">
        <video src="@_currentSong?.Data" id="video" width="400px" height="300px" autoplay="autoplay">
        </video>
    </div>
    <div style="flex: 50%;">
        @foreach (var debug in _debug)
        {
            <p style="padding: 0;margin:0">@debug</p>
        }
    </div>
</div>

@* <p>@_songs[_index]?.Name</p> *@
@* <p>@_songs[_index + 1]?.Name</p> *@

@code {

    class Song
    {
        public string Name { get; set; }

        public string Url { get; set; }

        public string Data { get; set; }
    }

    private readonly HttpClient _client = new();

    private int preloadAmount = 1;

    private readonly List<string> _debug = new() { "" };

    private List<Song?> _songs = new()
    {
        new Song { Name = "dummySong0", Data = "", Url = "" },
        new Song { Name = "dummySong1", Data = "", Url = "" }
    };

    private int _index;

    private Song? _currentSong;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        _debug.Add("init");
        var songs = new List<Song?>
        {
            new()
            {
                Name = "burst",
                Url = "https://files.catbox.moe/b4b5wl.mp3",
                Data = ""
            },
            new()
            {
                Name = "shuffle",
                Url = "https://files.catbox.moe/8sxb1b.webm",
                Data = ""
            },
            new()
            {
                Name = "inukami",
                Url = "https://files.catbox.moe/kk3ndn.mp3",
                Data = ""
            },
            new()
            {
                Name = "gintama",
                Url = "https://files.catbox.moe/ftvkr9.mp3",
                Data = ""
            },
            new()
            {
                Name = "lovehina",
                Url = "https://files.catbox.moe/pwuc9j.mp3",
                Data = ""
            },
            new()
            {
                Name = "akunohana",
                Url = "https://files.catbox.moe/dupkk6.webm",
                Data = ""
            },
            new()
            {
                Name = "fsn",
                Url = "https://files.catbox.moe/d1boaz.webm",
                Data = ""
            },
            new()
            {
                Name = "h2o",
                Url = "https://files.catbox.moe/tf82bf.webm",
                Data = ""
            },
        };
        _songs = songs;

        await ResetToStart();
    }

    private async Task SwapSongs()
    {
        if (_index + 1 < _songs.Count)
        {
            _debug.Add("oldSong: " + _songs[_index]!.Name);

            _index += 1;
            _debug.Add("index: " + _index);

            _currentSong = _songs.ElementAtOrDefault(_index);
            _debug.Add("newSong: " + _currentSong?.Name);

            await Preload(_index, preloadAmount);
        }
        else
        {
            await ResetToStart();
        }
    }

    private async Task ResetToStart()
    {
        _index = 0;

        Song dledSong = await DlSong(_songs[_index]!);
        _currentSong = dledSong;
        StateHasChanged();

        await Preload(_index);
        StateHasChanged();
    }

    private async Task Preload(int index, int amount = 1) // todo take song as param?
    {
        for (int i = 1; i <= amount; i++)
        {
            if (index + i < _songs.Count)
            {
                Song song = await DlSong(_songs[index + i]!);
                _songs[index + i] = song;
                _debug.Add($"{song.Name} is ready");
            }
            else
            {
                _logger.LogWarning("no song to preload");
            }
        }
    }

    private async Task<Song> DlSong(Song song)
    {
        _debug.Add($"downloading {song.Name}");
        string data = await _jsRuntime.InvokeAsync<string>("fetchObjectUrl", song.Url);

        var ret = new Song
        {
            Name = song.Name,
            Url = song.Url,
            Data = data
        };

        return ret;
    }

}
