<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="description" content="Eroge Music Quiz">

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>EMQ</title>
    <base href="/"/>

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet"/>
    <link href="css/bootstrap-icons/bootstrap-icons.min.css" rel="stylesheet"/>
    <link href="css/font-awesome-5.15.4/css/all.css" rel="stylesheet"/>

    <link href="css/app.css" rel="stylesheet"/>
    <link href="EMQ.Client.styles.css" rel="stylesheet"/>

    <link href="_content/Blazorise/blazorise.css" rel="stylesheet"/>
    <link href="_content/Blazorise.Bootstrap5/blazorise.bootstrap5.css" rel="stylesheet"/>
</head>

<body>
<div id="app">
    <svg class="loading-progress">
        <circle r="40%" cx="50%" cy="50%"/>
        <circle r="40%" cx="50%" cy="50%"/>
    </svg>
    <div class="loading-progress-text"></div>
</div>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">ðŸ—™</a>
</div>

<script src="js/bootstrap/bootstrap.bundle.min.js"></script>
<script src="_framework/blazor.webassembly.js"></script>

<!--https://getbootstrap.com/docs/5.3/customize/color-modes/#javascript-->
<script>
    /*!
     * Color mode toggler for Bootstrap's docs (https://getbootstrap.com/)
     * Copyright 2011-2023 The Bootstrap Authors
     * Licensed under the Creative Commons Attribution 3.0 Unported License.
     */

    (async function ThemeStuff() {
        'use strict'

        const getStoredTheme = () => localStorage.getItem('theme')
        const setStoredTheme = theme => localStorage.setItem('theme', theme)

        const getPreferredTheme = () => {
            const storedTheme = getStoredTheme()
            if (storedTheme) {
                return storedTheme
            }

            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
        }

        const setTheme = theme => {
            // console.log("setTheme " + theme)
            if (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-bs-theme', 'dark')
            } else {
                document.documentElement.setAttribute('data-bs-theme', theme)
            }
        }

        setTheme(getPreferredTheme())

        const showActiveTheme = async (theme, focus = false) => {
            // console.log("showActiveTheme " + theme)
            let themeSwitcher;
            while (true) {
                themeSwitcher = document.querySelector('#bd-theme')
                if (!themeSwitcher) {
                    console.log("themeSwitcher was not found")
                    await new Promise(r => setTimeout(r, 2000));
                } else {
                    console.log("themeSwitcher was found")
                    break;
                }
            }

            const themeSwitcherText = document.querySelector('#bd-theme-text')
            // const activeThemeIcon = document.querySelector('.theme-icon-active use')
            const btnToActive = document.querySelector(`[data-bs-theme-value="${theme}"]`)
            // const svgOfActiveBtn = btnToActive.querySelector('svg use').getAttribute('href')

            document.querySelectorAll('[data-bs-theme-value]').forEach(element => {
                element.classList.remove('active')
                element.setAttribute('aria-pressed', 'false')
            })

            btnToActive.classList.add('active')
            btnToActive.setAttribute('aria-pressed', 'true')
            // activeThemeIcon.setAttribute('href', svgOfActiveBtn)
            const themeSwitcherLabel = `${themeSwitcherText.textContent} (${btnToActive.dataset.bsThemeValue})`
            themeSwitcher.setAttribute('aria-label', themeSwitcherLabel)

            if (focus) {
                themeSwitcher.focus()
            }
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            const storedTheme = getStoredTheme()
            if (storedTheme !== 'light' && storedTheme !== 'dark') {
                setTheme(getPreferredTheme())
            }
        })

        window.addEventListener('DOMContentLoaded', async () => {
            // console.log("DOMContentLoaded fired")
            await showActiveTheme(getPreferredTheme())

            document.querySelectorAll('[data-bs-theme-value]')
                .forEach(toggle => {
                    // console.log("found toggle")
                    toggle.addEventListener('click', async () => {
                        // console.log("clicked")
                        const theme = toggle.getAttribute('data-bs-theme-value')
                        setStoredTheme(theme)
                        setTheme(theme)
                        await showActiveTheme(theme, true)
                    })
                })
        })
    })();

    const beforeUnloadEvent = function (event) {
        event.preventDefault();
    };

    function addQuizPageEventListeners() {
        addBeforeUnload();
    }

    function removeQuizPageEventListeners() {
        removeBeforeUnload();
    }

    function addBeforeUnload() {
        addEventListener('beforeunload', beforeUnloadEvent);
    }

    function removeBeforeUnload() {
        removeEventListener('beforeunload', beforeUnloadEvent);
    }

    function scrollToEnd(element) {
        if (element) {
            element.scrollTop = element.scrollHeight;
        }
    }

    function changeLocation(input) {
        window.location.href = input;
    }

    async function setVideoVolume(volume) {
        try {
            const video = document.getElementById('video');
            video.volume = volume;
            // console.log("set video volume to " + volume)
        } catch (err) {
            console.log(err)
        }
    }

    async function reloadVideo(startTime) {
        // console.log("here")
        try {
            const video = document.getElementById('video');
            // console.log(video)
            console.log("seeking to startTime " + startTime)
            video.currentTime = startTime;
        } catch (err) {
            console.log(err)
        }
    }

    class Helpers {
        static controller = new AbortController();

        static async fetchObjectUrl(src) {
            this.controller = new AbortController(); // not sure if we need this line
            const signal = this.controller.signal;

            return await fetch(src, {signal})
                .then((response) => {
                    if (response.ok) {
                        return response;
                    } else {
                        return Promise.reject(response);
                    }
                })
                .then(async (response) => {
                    const blob = await response.blob();
                    console.log("dled");
                    return URL.createObjectURL(blob);
                })
                .catch((response) => {
                    let s = `response was null or empty`;
                    if (response != null && response !== '') {
                        s = `${response.status}|${response.statusText}|`;
                        if (response.body != null) {
                            response.json().then((json) => {
                                s += json
                            })
                        }
                    }

                    console.log(s);
                    return s;
                });
        }

        static abortFetch() {
            this.controller.abort();
            console.log('fetchObjectUrl aborted!');
        }
    }

    window.Helpers = Helpers;
</script>

</body>

</html>
